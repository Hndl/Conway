<!DOCTYPE html>
<html>
	<title>Code Example: Conway's Game Of Life</title>
	
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/p5.js"></script>
	<script type="text/javascript">
		const WHITE 			= 255
		const BLACK 			= 0
		const RESOLUTION = 20 	
		const WORLD_WIDTH = 600
		const WORLD_HEIGHT = 600
		const MAXCOL = WORLD_WIDTH / RESOLUTION
		const MAXROW = WORLD_HEIGHT / RESOLUTION
		const ALIVE = 1;
		const DEAD = 0;
		
		var world = []
		
		function setup() {
    
 			canvas = createCanvas(window.innerWidth, window.innerHeight)	
		
 			ellipseMode(CENTER)
 			background(WHITE)
 			
 			for ( let r = 0 ; r< MAXROW ; r++) {
 				let cols = []
 				for ( let c = 0 ; c <MAXCOL ; c++){
 					let cellStatus = ( floor(random(1,100))>90? ALIVE : DEAD )
 					//let cellStatus = `${c}x${r}`
 					//let cellStatus = DEAD
 					cols.push(cellStatus)
 				}
 				world.push(cols)
 			}
			//console.table(world)

			world[5][4] = ALIVE
			world[5][5] = ALIVE
			world[5][6] = ALIVE

			world[4][3] = ALIVE
			world[4][4] = ALIVE
			world[4][5] = ALIVE
			

			//console.table(world)

			frameRate(5)
		}
		function draw() {
			
				
			for ( let row = 0 ; row < MAXROW ; row++) {
				for ( let col = 0 ; col < MAXCOL ; col++){
					strokeWeight(1)
					stroke(BLACK)
					let cellStatus = world[row][col]
					if ( cellStatus === ALIVE ){
						fill(0,0,0)
					} else {
						fill(255,255,255)
					}
					
				
					rect(col*RESOLUTION,row*RESOLUTION,RESOLUTION, RESOLUTION)
				}

			}
			
			world = apply_life_rules( world )

			//noLoop()
		}
		function cloneWorld ( _W ) {
			let newWorld = []
			for ( let r = 0 ; r< MAXROW ; r++) {
 				let newWorldCol = []
 				for ( let c = 0 ; c <MAXCOL ; c++){
 					let cellStatus = _W[r][c]
 					newWorldCol.push(cellStatus)
 				}
 				newWorld.push(newWorldCol)
 			}
 			//console.log('world has been cloned')
 			//console.table( newWorld)
			return (newWorld)
		}
		
		function apply_life_rules ( _W ) {
			
			//? should this be a clone of the old or an empty
			let newWorld = cloneWorld(_W)

			//console.log('processing new world')
			

			//TODO edge wrap NSEW
			for ( let r = 1 ; r < _W.length-1 ; r++){
				for ( let c = 1 ; c < _W[r].length-1 ; c++){
					//We must apply the rules to the current world map and put the results in the new World map
					let neighbors = 0
					//console.log(`processing ${c} of ${_W.length} and ${r} of ${_W[c].length}`)
					


					// TODO opt 
					
					//neighbors += _W[r][c]    // C/C
					neighbors += _W[r][c-1]    // C/E
					neighbors += _W[r][c+1]    // C/W
					
					neighbors += _W[r-1][c]    // N/C
					neighbors += _W[r-1][c-1]    // N/E
					neighbors += _W[r-1][c+1]    // N/W

					neighbors += _W[r+1][c]    // S/C
					neighbors += _W[r+1][c-1]    // S/E
					neighbors += _W[r+1][c+1]    // S/W

					
					/*
					 TODO - something wrong with this...
					try{ 
						for ( let i = -1 ; i < 2 ; i++){
							for (let j = -1; i<2 ; j++){
								let ci = c+i
								let rj = r+j
								neighbors += _W[ci][rj]
							}
						}
					} catch (err ) {
						console.log(err)
					}*/

					/*
					Any live cell with fewer than two live neighbors dies, as if by underpopulation. 0,1
					Any live cell with two or three live neighbors lives on to the next generation. 2, 3
					Any live cell with more than three live neighbors dies, as if by overpopulation. >3 see default
					Any dead cell with exactly three live neighbors becomes a live cell, as if by reproduction.
					*/

					let rule = ''

					switch (neighbors){
						case 0:
						case 1:
							newWorld[r][c]=DEAD
							rule = '0/1'	
							break;
						case 2: // lives on
						case 3: // lives on or rebirth
							rule = 'no change'
							if ( _W[r][c] === ALIVE) {
								newWorld[r][c] = ALIVE
								rule = 'Alive: 2/3'
							}

							if (_W[r][c] === DEAD && neighbors === 3){
								newWorld[r][c] = ALIVE 			
								rule = 'Dead: 3'	
							}
							break;

						default:
							rule='def'
							//overpopulation > 3 <0 or 1 underpopulation
							newWorld[r][c]= DEAD 	
					}

					/*if ( neighbors > 0 ) {
						console.log('----- New World Tick----- ')
						console.log(`new world col:${c} row:${r} oldState:${_W[r][c]} neighbors:${neighbors} newState:${newWorld[r][c]} rule:${rule}`)
						console.log('Old World')
						console.table(_W)
						console.log('New World')
						console.table(newWorld)
						console.log('=====================')
					}*/
				}
			}
			//console.log('processing of new world complete')
			return newWorld
			
		}
		
		
	
	</script>
<body>

</body>
</html>
